<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KatCall</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="icon.png" type="image/png">
</head>
<body>
    <div id="app">
        <!-- Экран регистрации/входа -->
        <div id="auth-screen" class="screen">
            <h1>Добро пожаловать в Мессенджер!</h1>
            <div class="form">
                <input type="text" id="username" placeholder="Ваше имя (логин)" maxlength="20">
                <button onclick="register()">Зарегистрироваться</button>
                <p>Или войдите, если уже есть аккаунт:</p>
                <input type="text" id="login-name" placeholder="Имя">
                <button onclick="login()">Войти</button>
            </div>
        </div>

        <!-- Основной экран чата -->
        <div id="chat-screen" class="screen hidden">
            <header>
                <h2>Чаты</h2>
                <button onclick="logout()">Выйти</button>
            </header>
            <div id="chats-list"></div>
            <div class="input-area">
                <input type="text" id="new-chat" placeholder="Имя собеседника для нового чата">
                <button onclick="createChat()">Создать чат</button>
            </div>
        </div>

        <!-- Экран конкретного чата -->
        <div id="messages-screen" class="screen hidden">
            <header>
                <button onclick="backToChats()">← Назад</button>
                <h2 id="chat-title">Чат</h2>
            </header>
            <div id="messages"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Введите сообщение..." maxlength="500">
                <button onclick="sendMessage()">Отправить</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .channel-list { list-style: none; overflow-y: auto; flex: 1; }
        .channel-item { padding: 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; background: var(--glass-bg); display: flex; align-items: center; }
        .channel-item:hover { background: rgba(255,255,255,0.1); }
        .channel-avatar { width: 35px; height: 35px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 14px; margin-right: 10px; }

        /* Chat Area styles */
        .chat-header { padding: 15px; border-bottom: var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .status-dot { height: 8px; width: 8px; background-color: var(--offline-color); border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background-color: var(--online-color); }

        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 12px; position: relative; font-size: 14px; }
        .message.sent { align-self: flex-end; background: rgba(100, 255, 218, 0.3); }
        .message.received { align-self: flex-start; background: rgba(255, 255, 255, 0.2); }
        
        .input-area { padding: 15px; border-top: var(--glass-border); display: flex; gap: 10px; align-items: center; }

        /* --- Modal Styles --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal-content { padding: 30px; width: 350px; text-align: center; }
        .modal-content input { margin-bottom: 20px; }
        .modal-content button { width: 45%; margin: 5px; }
    </style>
</head>
<body>

    <div id="auth-container" class="glass">
        
        <div id="login-screen" class="auth-screen">
            <h1>KatCall (Вход)</h1>
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPass" placeholder="Пароль">
            <button onclick="login()">Войти</button>
            <p style="margin-top:20px; font-size: 14px; opacity: 0.8;">
                Нет аккаунта? <a href="#" onclick="showRegister()" style="color: #667eea; text-decoration: none;">Зарегистрироваться</a>
            </p>
        </div>

        <div id="register-screen" class="auth-screen">
            <h1>KatCall (Регистрация)</h1>
            <input type="email" id="regEmail" placeholder="Email">
            <input type="text" id="regUser" placeholder="Username (Логин)">
            <input type="password" id="regPass" placeholder="Пароль">
            <button onclick="register()">Создать аккаунт</button>
            <p style="margin-top:20px; font-size: 14px; opacity: 0.8;">
                Уже зарегистрированы? <a href="#" onclick="showLogin()" style="color: #667eea; text-decoration: none;">Войти</a>
            </p>
        </div>
    </div>

    <div id="app-screen" class="glass">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Чаты</h3>
                <div style="display: flex;">
                    <button class="icon-btn" onclick="toggleTheme()" title="Сменить тему"><i class="fas fa-adjust"></i></button>
                    <button class="icon-btn" onclick="openCreateChannelModal()" title="Создать канал"><i class="fas fa-plus"></i></button>
                </div>
            </div>
            
            <input type="text" id="search-input" placeholder="Поиск по username" oninput="searchUsers(this.value)" style="margin: 0 0 15px 0; padding: 8px;">

            <ul class="channel-list" id="channel-list">
                </ul>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div>
                    <h3 id="current-chat-name">Общий Чат</h3>
                    <small id="chat-status"><span class="status-dot online"></span> Online</small>
                </div>
                <small id="user-display">@User</small>
            </div>
            
            <div class="messages" id="messages"></div>

            <div class="input-area">
                <input id="msg" placeholder="Сообщение..." style="flex:1;" onkeypress="handleEnter(event)">
                <button class="icon-btn" title="Отправить файл (симуляция)"><i class="fas fa-paperclip"></i></button>
                <button class="icon-btn" title="Голосовое сообщение (симуляция)"><i class="fas fa-microphone"></i></button>
                <button class="icon-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="create-channel-modal" class="modal">
        <div class="glass modal-content">
            <h3>Создание Канала</h3>
            <input type="text" id="new-channel-name" placeholder="Название канала">
            <input type="text" id="new-channel-username" placeholder="@username канала (уникальный)">
            <button onclick="createChannel()">Создать</button>
            <button onclick="closeCreateChannelModal()" style="background: rgba(255,0,0,0.3)">Отмена</button>
        </div>
    </div>

<script>
    /* ========== CONFIG & STATE ========== */
    let currentUserEmail = null;
    let users = {}; 
    let channels = {
        'General': { name: 'Общий Чат', username: 'General', type: 'channel' }
    };

    /* ========== ИНИЦИАЛИЗАЦИЯ (ЗАГРУЗКА JSON/LocalStorage) ========== */

    async function initApp() {
        // 1. Попытка загрузить данные из users.json (для первоначальной базы)
        try {
            const response = await fetch('users.json');
            if (response.ok) {
                const jsonUsers = await response.json();
                Object.assign(users, jsonUsers);
            }
        } catch (error) {
            console.warn("Не удалось загрузить users.json. Проверьте, что файл users.json загружен на GitHub.");
        }

        // 2. Слияние с Local Storage (для сохранения новых регистраций/каналов в браузере)
        const localUsers = JSON.parse(localStorage.getItem("katcall_users"));
        if (localUsers) {
            Object.assign(users, localUsers);
        }
        const localChannels = JSON.parse(localStorage.getItem("katcall_channels"));
        if (localChannels) {
            Object.assign(channels, localChannels);
        }
        
        // 3. Отображение экрана авторизации/регистрации
        document.getElementById('auth-container').style.display = 'flex';
        showLogin();
        renderChannelList();
    }

    initApp();

    /* ========== AUTH LOGIC ========== */

    function saveUsers() {
        if (currentUserEmail) {
            users[currentUserEmail].lastSeen = new Date().toLocaleString();
        }
        localStorage.setItem("katcall_users", JSON.stringify(users));
        localStorage.setItem("katcall_channels", JSON.stringify(channels));
    }
    
    function showLogin() {
        document.getElementById('register-screen').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
    }

    function showRegister() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('register-screen').style.display = 'flex';
    }

    function register() {
        const email = document.getElementById("regEmail").value.trim();
        const user = document.getElementById("regUser").value.trim();
        const pass = document.getElementById("regPass").value.trim();

        if (!email || !user || !pass) return alert("Заполните все поля!");
        if (users[email]) return alert("Пользователь с таким email уже существует!");

        users[email] = {
            username: user,
            password: pass,
            lastSeen: "Online"
        };
        saveUsers();
        alert(`Аккаунт @${user} успешно создан!`);
        showLogin();
    }

    function login() {
        const email = document.getElementById("loginEmail").value.trim();
        const pass = document.getElementById("loginPass").value.trim();

        if (!email || !pass) return alert("Введите email и пароль!");
        if (!users[email] || users[email].password !== pass) {
            alert("Неверный email или пароль!");
            return;
        }

        loginSuccess(email);
    }

    function loginSuccess(email) {
        currentUserEmail = email;
        const user = users[email].username;

        document.getElementById("auth-container").style.display = "none";
        document.getElementById("app-screen").style.display = "flex";
        document.getElementById("user-display").innerText = `@${user}`;

        users[email].lastSeen = "Online";
        saveUsers(); 
        
        selectChat('General');
    }

    /* ========== CHANNEL & SEARCH LOGIC ========== */

    function renderChannelList(filter = '') {
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        
        const allItems = { ...channels };
        // Добавляем пользователей в список для поиска 1-на-1
        for (const email in users) {
            if (email !== currentUserEmail) { 
                const user = users[email];
                allItems[`@${user.username}`] = { 
                    name: user.username, 
                    username: user.username, 
                    type: 'user', 
                    lastSeen: user.lastSeen 
                };
            }
        }

        for (const key in allItems) {
            const item = allItems[key];
            const filterLower = filter.toLowerCase();
            const nameMatch = item.name.toLowerCase().includes(filterLower);
            const userMatch = item.username.toLowerCase().includes(filterLower);

            if (filter === '' || nameMatch || userMatch) {
                const li = document.createElement('li');
                li.className = 'channel-item';
                li.setAttribute('onclick', `selectChat('${item.username}')`);

                const avatarText = item.type === 'channel' ? item.name[0] : '@';
                const typeText = item.type === 'channel' ? 'Канал' : 'Пользователь';

                li.innerHTML = `
                    <div class="channel-avatar">${avatarText.toUpperCase()}</div>
                    <div class="info">
                        <h4>${item.name}</h4>
                        <small>@${item.username} (${typeText})</small>
                    </div>
                `;
                list.appendChild(li);
            }
        }
    }

    function searchUsers(filter) {
        renderChannelList(filter);
    }

    function openCreateChannelModal() {
        document.getElementById('create-channel-modal').style.display = 'flex';
    }
    
    function closeCreateChannelModal() {
        document.getElementById('create-channel-modal').style.display = 'none';
        document.getElementById('new-channel-name').value = '';
        document.getElementById('new-channel-username').value = '';
    }

    function createChannel() {
        const name = document.getElementById('new-channel-name').value.trim();
        const username = document.getElementById('new-channel-username').value.trim();

        if (!name || !username) return alert("Заполните оба поля!");
        if (channels[username]) return alert("Канал с таким username уже существует!");

        channels[username] = {
            name: name,
            username: username,
            type: 'channel',
            createdBy: users[currentUserEmail].username
        };
        saveUsers();
        
        closeCreateChannelModal();
        renderChannelList();
        selectChat(username);
    }

    /* ========== CHAT LOGIC SIMULATION ========== */

    function handleEnter(e) {
        if(e.key === 'Enter') sendMsg();
    }

    function sendMsg() {
        const msg = document.getElementById("msg").value.trim();
        if (!msg) return;
        addMessage(`[${users[currentUserEmail].username}] ${msg}`, "sent");
        document.getElementById("msg").value = "";

        const currentChatUsername = document.getElementById('current-chat-name').getAttribute('data-username');
        setTimeout(() => {
            addMessage(`(Бот) Привет от ${currentChatUsername}!`, 'received');
        }, 1500);
    }

    function addMessage(text, type) {
        const box = document.getElementById("messages");
        const div = document.createElement("div");
        div.className = "message " + type;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function selectChat(username) {
        const currentChat = channels[username] || users[Object.keys(users).find(k => users[k].username === username)];
        if (!currentChat) return;

        document.getElementById('current-chat-name').innerText = currentChat.name || currentChat.username;
        document.getElementById('current-chat-name').setAttribute('data-username', username);
        document.getElementById('messages').innerHTML = ''; 
        
        let statusText = "Offline";
        let isOnline = false;

        if (currentChat.type === 'channel') {
            isOnline = true; 
            statusText = "Канал";
        } else {
            // User chat simulation
            const lastSeen = currentChat.lastSeen;
            if (lastSeen === "Online") {
                 isOnline = true;
                 statusText = "Online";
            } else {
                 statusText = `был(а) ${lastSeen}`;
            }
        }

        const statusDot = document.querySelector('#chat-status .status-dot');
        if (isOnline) {
            statusDot.classList.add('online');
        } else {
            statusDot.classList.remove('online');
        }
        document.getElementById('chat-status').innerHTML = `<span class="status-dot ${isOnline ? 'online' : ''}"></span> ${statusText}`;

        addMessage(`Вы вошли в чат: ${currentChat.name || currentChat.username}.`, 'received');
    }

    /* ========== ТЕМА И ЭКСПОРТ ДАННЫХ ========== */

    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
    }
    
    // Инструмент для ручного сохранения прогресса в users.json
    // Вызовите эту функцию в консоли разработчика (F12) для получения данных
    function exportUserData() {
        const data = {
            users: JSON.parse(localStorage.getItem("katcall_users")),
            channels: JSON.parse(localStorage.getItem("katcall_channels"))
        };
        
        if (data.users) {
            console.log("==========================================");
            console.log("ДАННЫЕ ПОЛЬЗОВАТЕЛЕЙ (USERS) - скопируйте в users.json:");
            console.log("==========================================");
            console.log(JSON.stringify(data.users, null, 2));
        }
        if (data.channels) {
            console.log("==========================================");
            console.log("ДАННЫЕ КАНАЛОВ (CHANNELS) - скопируйте для резерва:");
            console.log("==========================================");
            console.log(JSON.stringify(data.channels, null, 2));
        }
        
        alert("Данные для обновления users.json скопированы в консоль (F12 -> Console)");
    }

    window.addEventListener('beforeunload', saveUsers);
</script>
</body>
</html>

